<!DOCTYPE html>
<html lang="zh_cn">
<head>
    <meta charset="UTF-8">
    <title>水印</title>
    <style>
        body{
            background-color: antiquewhite;
            padding: 30px;
        }
    </style>
</head>
<body>
<div>
    <h2>原图片</h2>
    <canvas></canvas>
</div>
<div>
    <h2>含有可见水印的图片</h2>
    <canvas></canvas>
</div>
<div>
    <h2>数字水印图片</h2>
    <canvas></canvas>
</div>
<div>
    <h2>添加了数字水印的图片</h2>
    <canvas></canvas>
</div>
<div>
    <h2>提取水印</h2>
    <canvas></canvas>
</div>
<script>
    const img = new Image();
    img.src = 'assets/38631998_p0_master1200.jpg';
    const sign = new Image();
    sign.src = 'assets/sign.png';
    const cs = document.getElementsByTagName("canvas");
    img.onload = function() {
        let w = img.naturalWidth;
        let h = img.naturalHeight;
        console.log(w + '  ' + h);

        cs[0].width=w;
        cs[0].height=h;
        cs[0].getContext("2d").drawImage(img,0,0);

        cs[1].width=w;
        cs[1].height=h;
        cs[1].getContext("2d").drawImage(img,0,0);
        cs[1].getContext("2d").drawImage(sign,w-256,0);

        cs[2].width=256;
        cs[2].height=256;
        cs[2].getContext("2d").drawImage(sign,0,0);

        cs[3].width=w;
        cs[3].height=h;
        var img_data = cs[0].getContext("2d").getImageData(0,0,w,h);
        var sign_data = cs[2].getContext("2d").getImageData(0,0,256,256);
        for(var i=0; i<256; i++) {
            for(var j=0; j<256; j++) {
                var p_s=(i*256+j)*4;
                var i_s=(w-256+i*w+j)*4;
                var a=sign_data.data[p_s+3];
                if(a>0) {
                    img_data.data[i_s]&=0xFE; //红色最后一位置0
                }
                else {
                    img_data.data[i_s]|=0x01; //红色最后一位置1
                }
            }
        }
        cs[3].getContext("2d").putImageData(img_data,0,0);

        cs[4].width=w;
        cs[4].height=h;
        var signed_img_data = cs[3].getContext("2d").getImageData(0,0,w,h);
        var extract_img_data = cs[4].getContext("2d").getImageData(0,0,w,h);
        for(var i=0; i<signed_img_data.data.length; i+=4) {
            if(signed_img_data.data[i]&0x01) {
                extract_img_data.data[i]=0;
                extract_img_data.data[i+1]=0;
                extract_img_data.data[i+2]=0;
                extract_img_data.data[i+3]=255;
            }
            else {
                extract_img_data.data[i]=255;
                extract_img_data.data[i+1]=255;
                extract_img_data.data[i+2]=255;
                extract_img_data.data[i+3]=255;
            }
        }
        cs[4].getContext("2d").putImageData(extract_img_data,0,0);
    }

</script>
</body>
</html>